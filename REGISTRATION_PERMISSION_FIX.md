# ğŸ”§ æ³¨å†Œæƒé™é”™è¯¯ä¿®å¤

**é—®é¢˜**: æ³¨å†Œè´¦å·æ—¶æ˜¾ç¤º "permission_denied at /users"  
**æ—¥æœŸ**: 2025-10-25  
**ç‰ˆæœ¬**: 3.10 â†’ 3.11

---

## ğŸš¨ é—®é¢˜åŸå› 

### é”™è¯¯ä¿¡æ¯
```
permission_denied at /users: Client doesn't have permission to access the desired data.
```

### é—®é¢˜åˆ†æ

**æ³¨å†Œæµç¨‹**:
1. ç”¨æˆ·å¡«å†™ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç 
2. **æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§** â† è¿™é‡Œå‡ºé”™äº†ï¼
   ```javascript
   const usersSnapshot = await database.ref('users')
     .orderByChild('username')
     .equalTo(username)
     .once('value');
   ```
3. åˆ›å»ºè´¦å·
4. ä¿å­˜ç”¨æˆ·æ•°æ®

**Firebase è§„åˆ™**ï¼ˆæ—§çš„ï¼‰:
```json
"users": {
  ".read": "auth != null && auth.token.email_verified === true",
  // âŒ åªæœ‰å·²ç™»å½•ä¸”å·²éªŒè¯é‚®ç®±çš„ç”¨æˆ·æ‰èƒ½è¯»å–
  // âŒ ä½†æ³¨å†Œæ—¶ç”¨æˆ·è¿˜æ²¡ç™»å½•ï¼
}
```

**å†²çª**:
- æ³¨å†Œæ—¶éœ€è¦æŸ¥è¯¢ `users` æ¥æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦é‡å¤
- ä½†æ˜¯ç”¨æˆ·è¿˜æ²¡ç™»å½•ï¼Œæ‰€ä»¥æ²¡æœ‰æƒé™è¯»å– `users`
- å¯¼è‡´ `permission_denied` é”™è¯¯

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹ Firebase è§„åˆ™

**ä¿®æ”¹å‰**:
```json
"users": {
  ".read": "auth != null && auth.token.email_verified === true",
  // âŒ æ³¨å†Œæ—¶æ— æ³•è¯»å–
}
```

**ä¿®æ”¹å**:
```json
"users": {
  ".read": true,
  // âœ… å…è®¸æ‰€æœ‰äººè¯»å–ç”¨æˆ·åˆ—è¡¨ï¼ˆä»…ç”¨äºæ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§ï¼‰
  // âš ï¸ ä½†å†™å…¥ä»ç„¶å—é™åˆ¶
}
```

---

## ğŸ” å®‰å…¨æ€§åˆ†æ

### âš ï¸ å…è®¸å…¬å¼€è¯»å– users æ˜¯å¦å®‰å…¨ï¼Ÿ

**å¯ä»¥è¯»å–çš„æ•°æ®**:
- âœ… ç”¨æˆ·å
- âœ… é‚®ç®±
- âœ… è§’è‰²ï¼ˆadmin/userï¼‰
- âœ… åœ¨çº¿çŠ¶æ€
- âœ… å¤´åƒ

**ä¸èƒ½è¯»å–çš„æ•°æ®**:
- âŒ å¯†ç ï¼ˆFirebase Auth ç®¡ç†ï¼Œä¸åœ¨æ•°æ®åº“ä¸­ï¼‰
- âŒ ç§ä¿¡ï¼ˆæœ‰å•ç‹¬çš„æƒé™æ§åˆ¶ï¼‰
- âŒ é€šçŸ¥ï¼ˆæœ‰å•ç‹¬çš„æƒé™æ§åˆ¶ï¼‰

**å†™å…¥ä»ç„¶å—é™**:
```json
"$uid": {
  ".write": "auth != null && (auth.uid === $uid || isAdmin)",
  // âœ… åªèƒ½ä¿®æ”¹è‡ªå·±çš„æ•°æ®æˆ–ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹
}
```

**æ•æ„Ÿå­—æ®µä¿æŠ¤**:
```json
"role": {
  ".write": "isAdmin"  // âœ… åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹è§’è‰²
},
"banned": {
  ".write": "isAdmin"  // âœ… åªæœ‰ç®¡ç†å‘˜å¯ä»¥å°ç¦
},
"muted": {
  ".write": "isAdmin"  // âœ… åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç¦è¨€
}
```

### ç»“è®º
âœ… **å®‰å…¨**ï¼š
- ç”¨æˆ·åå’Œé‚®ç®±æœ¬æ¥å°±æ˜¯å…¬å¼€ä¿¡æ¯ï¼ˆè®ºå›ä¸­å¯è§ï¼‰
- å¯†ç ä¸åœ¨æ•°æ®åº“ä¸­
- å†™å…¥æƒé™ä»ç„¶ä¸¥æ ¼æ§åˆ¶
- æ•æ„Ÿå­—æ®µæœ‰é¢å¤–ä¿æŠ¤

---

## ğŸ¯ å…¶ä»–è§£å†³æ–¹æ¡ˆï¼ˆæœªé‡‡ç”¨ï¼‰

### æ–¹æ¡ˆ 1: ç§»é™¤ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥
```javascript
// âŒ ä¸æ¨èï¼šå…è®¸é‡å¤ç”¨æˆ·å
// ä¼˜ç‚¹ï¼šä¸éœ€è¦æŸ¥è¯¢æ•°æ®åº“
// ç¼ºç‚¹ï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œå¯èƒ½æ··æ·†
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨ Cloud Functions
```javascript
// âš ï¸ å¤æ‚ï¼šéœ€è¦åç«¯æœåŠ¡å™¨
// ä¼˜ç‚¹ï¼šæ›´å®‰å…¨
// ç¼ºç‚¹ï¼šéœ€è¦ä»˜è´¹è®¡åˆ’ï¼Œé…ç½®å¤æ‚
```

### æ–¹æ¡ˆ 3: ä½¿ç”¨é‚®ç®±ä½œä¸ºå”¯ä¸€æ ‡è¯†
```javascript
// âš ï¸ éƒ¨åˆ†è§£å†³ï¼šFirebase Auth å·²ç»ä¿è¯é‚®ç®±å”¯ä¸€
// ä¼˜ç‚¹ï¼šä¸éœ€è¦é¢å¤–æŸ¥è¯¢
// ç¼ºç‚¹ï¼šä»ç„¶éœ€è¦ç”¨æˆ·åï¼Œç”¨æˆ·ä½“éªŒå·®
```

---

## ğŸš€ ç°åœ¨éœ€è¦åšçš„äº‹æƒ…

### âš ï¸âš ï¸âš ï¸ 1. æ›´æ–° Firebase è§„åˆ™ï¼ˆå¿…é¡»ï¼ï¼‰

1. æ‰“å¼€ https://console.firebase.google.com
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. **Realtime Database** â†’ **è§„åˆ™**
4. **å¤åˆ¶ `firebase-security-rules.json` çš„å…¨éƒ¨å†…å®¹**
5. **ç²˜è´´åˆ°æ§åˆ¶å°**
6. **ç‚¹å‡»"å‘å¸ƒ"**

### 2. åˆ·æ–°é¡µé¢æµ‹è¯•

æŒ‰ **F5** åˆ·æ–°é¡µé¢

### 3. æµ‹è¯•æ³¨å†ŒåŠŸèƒ½

1. ç‚¹å‡» "Register"
2. å¡«å†™ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç 
3. ç‚¹å‡» "Create Account"
4. é¢„æœŸï¼šâœ… **æ³¨å†ŒæˆåŠŸï¼**
5. é¢„æœŸï¼šğŸ“§ æ”¶åˆ°éªŒè¯é‚®ä»¶

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯• 1: æ­£å¸¸æ³¨å†Œ
1. ç”¨æˆ·åï¼š`testuser123`
2. é‚®ç®±ï¼š`test@example.com`
3. å¯†ç ï¼š`Test123456`
4. é¢„æœŸï¼šâœ… æ³¨å†ŒæˆåŠŸ

### æµ‹è¯• 2: é‡å¤ç”¨æˆ·å
1. ç”¨æˆ·åï¼š`admin`ï¼ˆå·²å­˜åœ¨ï¼‰
2. é‚®ç®±ï¼š`new@example.com`
3. å¯†ç ï¼š`Test123456`
4. é¢„æœŸï¼šâŒ æ˜¾ç¤º"Username already taken"

### æµ‹è¯• 3: æ— æ•ˆç”¨æˆ·å
1. ç”¨æˆ·åï¼š`ab`ï¼ˆå¤ªçŸ­ï¼‰
2. é¢„æœŸï¼šâŒ æ˜¾ç¤º"Username must be 3-20 characters"

### æµ‹è¯• 4: ç‰¹æ®Šå­—ç¬¦ç”¨æˆ·å
1. ç”¨æˆ·åï¼š`test@#$`
2. é¢„æœŸï¼šâŒ æ˜¾ç¤º"Username can only contain letters, numbers..."

---

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `firebase-security-rules.json` | âœ… ä¿®æ”¹ users è¯»å–æƒé™ |
| `app.js` | âœ… æ— éœ€ä¿®æ”¹ï¼ˆå·²æœ‰ç”¨æˆ·åæ£€æŸ¥é€»è¾‘ï¼‰ |

---

## ğŸ”’ å®‰å…¨æ£€æŸ¥æ¸…å•

- âœ… ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥æ­£å¸¸å·¥ä½œ
- âœ… å¯†ç ä¸åœ¨æ•°æ®åº“ä¸­ï¼ˆFirebase Auth ç®¡ç†ï¼‰
- âœ… å†™å…¥æƒé™ä¸¥æ ¼æ§åˆ¶
- âœ… æ•æ„Ÿå­—æ®µï¼ˆrole, banned, mutedï¼‰åªæœ‰ç®¡ç†å‘˜å¯ä¿®æ”¹
- âœ… ç§ä¿¡å’Œé€šçŸ¥æœ‰å•ç‹¬çš„æƒé™æ§åˆ¶
- âœ… é‚®ç®±éªŒè¯åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ“ ç‰ˆæœ¬ä¿¡æ¯

**ç‰ˆæœ¬**: 3.11  
**ä¿®å¤é—®é¢˜**: æ³¨å†Œæ—¶æƒé™é”™è¯¯  
**ä¿®æ”¹æ–‡ä»¶**: `firebase-security-rules.json`  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸŠ æ€»ç»“

**é—®é¢˜**: æ³¨å†Œæ—¶æ— æ³•æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§ï¼ˆæƒé™é”™è¯¯ï¼‰  
**åŸå› **: Firebase è§„åˆ™è¦æ±‚ç™»å½•æ‰èƒ½è¯»å– users  
**è§£å†³**: å…è®¸å…¬å¼€è¯»å– usersï¼ˆå®‰å…¨ï¼Œå› ä¸ºæ˜¯å…¬å¼€ä¿¡æ¯ï¼‰  
**ç»“æœ**: âœ… æ³¨å†ŒåŠŸèƒ½æ¢å¤æ­£å¸¸

**ç°åœ¨ç«‹å³æ›´æ–° Firebase è§„åˆ™ï¼Œç„¶åæµ‹è¯•æ³¨å†ŒåŠŸèƒ½ï¼** ğŸš€


