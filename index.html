<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<meta name="description" content="A real-time forum and chat application">

<!-- Prevent caching - force browsers to always fetch latest version -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="app-version" content="5.1">

<title>Puff - Senior Reverse Engineer</title>

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<!-- iOS Icons -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text x='50' y='50' font-size='50' text-anchor='middle' dominant-baseline='central' fill='%23fff'>ğŸ’¬</text></svg>">

<!-- CSS with cache-busting -->
<link rel="stylesheet" href="style.css?v=5.1">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>

<div class="floating-shapes">
<div class="shape shape-1"></div>
<div class="shape shape-2"></div>
<div class="shape shape-3"></div>
<div class="shape shape-4"></div>
</div>
<!-- Update Notification -->
<div class="update-notification" id="updateNotification">
<div class="update-icon">â†‘</div>
<div class="update-content">
<div class="update-title">New Version Available!</div>
<div class="update-message">Version <span id="newVersionNumber"></span> is ready to install</div>
</div>
<div class="update-actions">
<button class="update-btn update-btn-primary" id="updateNowBtn">Update Now</button>
<button class="update-btn update-btn-secondary" id="updateLaterBtn">Later</button>
</div>
</div>

<!-- Custom Modal System -->
<div class="custom-modal-overlay" id="customModalOverlay">
<div class="custom-modal" id="customModal">
<div class="custom-modal-icon" id="customModalIcon"></div>
<div class="custom-modal-title" id="customModalTitle"></div>
<div class="custom-modal-message" id="customModalMessage"></div>
<div class="custom-modal-input-container" id="customModalInputContainer" style="display: none;">
<input type="text" class="custom-modal-input" id="customModalInput" placeholder="">
</div>
<div class="custom-modal-buttons" id="customModalButtons"></div>
</div>
</div>

<!-- App Container -->
<div id="app">

<!-- Login/Register Page -->
<div class="page-view active" id="authPage">
<div class="auth-container">
<div class="auth-box">
<h1 class="auth-title" id="authTitle">Community Forum</h1>
<p class="auth-subtitle" id="authSubtitle">Sign in to continue</p>

<!-- Login Form -->
<div class="auth-form" id="loginForm">
<div class="form-group">
<label class="form-label">Email</label>
<input type="email" id="loginEmail" class="form-input" placeholder="Enter your email">
</div>
<div class="form-group">
<label class="form-label">Password</label>
<input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
</div>
<div class="form-options">
<label class="checkbox-label">
<input type="checkbox" id="rememberMe">
<span>Remember me</span>
</label>
</div>
<button class="btn btn-primary" id="loginBtn">Sign In</button>
<p class="form-switch">Don't have an account? <a href="#" id="showRegister">Register</a></p>
</div>

<!-- Register Form -->
<div class="auth-form hidden" id="registerForm">
<div class="form-group">
<label class="form-label">Username</label>
<input type="text" id="registerUsername" class="form-input" placeholder="Choose a username" maxlength="20">
</div>
<div class="form-group">
<label class="form-label">Email</label>
<input type="email" id="registerEmail" class="form-input" placeholder="Enter your email">
</div>
<div class="form-group">
<label class="form-label">Password</label>
<input type="password" id="registerPassword" class="form-input" placeholder="Create a password">
</div>
<button class="btn btn-primary" id="registerBtn">Create Account</button>
<p class="form-switch">Already have an account? <a href="#" id="showLogin">Sign In</a></p>
</div>
</div>
</div>
</div>

<!-- Forum Page -->
<div class="page-view" id="forumPage">
<nav class="navbar">
<div class="nav-container">
<h2 class="nav-brand">Forum <span style="font-size: 10px; opacity: 0.5; margin-left: 8px;" id="versionDisplay">v5.1</span></h2>
<div class="nav-actions">
<button class="nav-btn" id="messagesInboxBtn" title="Messages">
ğŸ’¬ Messages <span class="inbox-badge" id="inboxBadge" style="display: none;">0</span>
</button>
<button class="nav-btn" id="avatarBtn" title="Change avatar">Profile</button>
<button class="nav-btn" id="adminPanelBtn" style="display: none;">Admin Panel</button>
<button class="nav-btn" id="logoutBtn">Logout</button>
</div>
</div>
</nav>

<div class="main-content">
<div class="content-wrapper">
<!-- Announcements -->
<section class="section">
<div class="section-header">
<h3 class="section-title">ğŸ“¢ Announcements</h3>
</div>
<div class="announcements" id="announcementsList">
<div class="loading-text">Loading announcements...</div>
</div>
<div id="showMoreAnnouncements" style="display: none; text-align: center; margin-top: 15px;">
<button class="btn btn-secondary" id="toggleAnnouncementsBtn">ğŸ“‹ Show More</button>
</div>
</section>

<!-- Chat Section -->
<section class="section">
<div class="section-header">
<h3 class="section-title">Discussion</h3>
<div class="header-actions">
<input type="text" class="search-input" id="searchInput" placeholder="ğŸ” Search messages...">
<span class="online-indicator" id="onlineCount">0 online</span>
</div>
</div>

<!-- Online Users List -->
<div class="online-users-bar" id="onlineUsersList">
<div class="loading-text">Loading online users...</div>
</div>
<div class="chat-box">
<div class="messages-container" id="messagesContainer">
<div class="loading-text">Loading messages...</div>
</div>
<div class="typing-indicator" id="typingIndicator" style="display: none;">
<div class="typing-dots">
<span></span>
<span></span>
<span></span>
</div>
<span class="typing-text"></span>
</div>
<div class="message-input-container" style="position: relative;">
<!-- Mention Autocomplete -->
<div class="mention-autocomplete" id="mentionAutocomplete" style="display: none;">
<div class="mention-autocomplete-list" id="mentionAutocompleteList"></div>
</div>
<!-- File Preview -->
<div class="file-preview-container" id="filePreviewContainer" style="display: none;">
<div class="file-preview-item" id="filePreviewItem">
<span class="file-preview-name" id="filePreviewName"></span>
<span class="file-preview-size" id="filePreviewSize"></span>
<button class="file-preview-remove" id="removeFileBtn">Ã—</button>
</div>
</div>
<div class="message-input-wrapper">
<input type="file" id="fileInput" style="display: none;" multiple>
<input type="file" id="folderInput" style="display: none;" webkitdirectory directory multiple>
<button class="btn-attach" id="attachFileBtn" title="Attach files">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
</svg>
</button>
<button class="btn-attach" id="attachFolderBtn" title="Attach folder">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
</svg>
</button>
<button class="btn-attach btn-emoji" id="emojiPickerBtn" title="Insert emoji">
ğŸ˜Š
</button>
<input type="text" id="messageInput" class="message-input" placeholder="Type your message..." maxlength="500">
<button class="btn btn-send" id="sendMessageBtn">Send</button>
</div>

<!-- Emoji Picker -->
<div class="emoji-picker" id="emojiPicker" style="display: none;">
<div class="emoji-picker-header">
<input type="text" id="emojiSearch" placeholder="Search emoji..." class="emoji-search">
</div>
<div class="emoji-picker-body" id="emojiPickerBody"></div>
</div>
</div>
</div>
</section>
</div>
</div>
</div>

<!-- Admin Panel -->
<div class="page-view" id="adminPage">
<nav class="navbar">
<div class="nav-container">
<h2 class="nav-brand">Admin Panel</h2>
<div class="nav-actions">
<button class="nav-btn" id="backToForumBtn">â† è¿”å›è®ºå›</button>
</div>
</div>
</nav>

<div class="main-content">
<div class="admin-sidebar">
<div class="admin-menu">
<button class="admin-menu-item active" data-tab="overview">
<span class="menu-icon">ğŸ“Š</span>
<span class="menu-text">æ€»è§ˆ</span>
</button>
<button class="admin-menu-item" data-tab="users">
<span class="menu-icon">ğŸ‘¥</span>
<span class="menu-text">ç”¨æˆ·ç®¡ç†</span>
</button>
<button class="admin-menu-item" data-tab="messages">
<span class="menu-icon">ğŸ’¬</span>
<span class="menu-text">æ¶ˆæ¯ç®¡ç†</span>
</button>
<button class="admin-menu-item" data-tab="announcements">
<span class="menu-icon">ğŸ“¢</span>
<span class="menu-text">å…¬å‘Šç®¡ç†</span>
</button>
<button class="admin-menu-item" data-tab="logs">
<span class="menu-icon">ğŸ“œ</span>
<span class="menu-text">æ“ä½œæ—¥å¿—</span>
</button>
<button class="admin-menu-item" data-tab="settings">
<span class="menu-icon">âš™ï¸</span>
<span class="menu-text">ç³»ç»Ÿè®¾ç½®</span>
</button>
<button class="admin-menu-item" data-tab="analytics">
<span class="menu-icon">ğŸ“ˆ</span>
<span class="menu-text">æ•°æ®åˆ†æ</span>
</button>
<button class="admin-menu-item" data-tab="permissions">
<span class="menu-icon">ğŸ”</span>
<span class="menu-text">æƒé™ç®¡ç†</span>
</button>
<button class="admin-menu-item" data-tab="backup">
<span class="menu-icon">ğŸ’¾</span>
<span class="menu-text">å¤‡ä»½æ¢å¤</span>
</button>
</div>

<!-- Mobile Menu Toggle -->
<button class="admin-mobile-toggle" id="adminMobileToggle">
<span class="hamburger-icon">â˜°</span>
</button>
</div>

<div class="admin-main">
<div class="content-wrapper">
<!-- Overview Tab -->
<div class="admin-tab active" id="tab-overview">
<div class="admin-header">
<h2 class="admin-title">æ•°æ®æ€»è§ˆ</h2>
<p class="admin-subtitle">ä¸€ç›®äº†ç„¶åœ°ç›‘æ§æ‚¨çš„ç¤¾åŒº</p>
</div>

<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
<div class="stat-value" id="totalUsers">0</div>
<div class="stat-change positive">æœ¬å‘¨ +12%</div>
</div>
<div class="stat-card">
<div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
<div class="stat-value" id="totalMessages">0</div>
<div class="stat-change positive">æœ¬å‘¨ +8%</div>
</div>
<div class="stat-card">
<div class="stat-label">åœ¨çº¿ç”¨æˆ·</div>
<div class="stat-value" id="onlineUsers">0</div>
<div class="stat-change">å®æ—¶æ•°æ®</div>
</div>
<div class="stat-card">
<div class="stat-label">ä»Šæ—¥æ¶ˆæ¯</div>
<div class="stat-value" id="todayMessages">0</div>
<div class="stat-change positive">è¾ƒæ˜¨æ—¥ +15%</div>
</div>
</div>

<div class="admin-grid">
<div class="admin-card">
<div class="card-header">
<h3 class="card-title">æœ€è¿‘æ´»åŠ¨</h3>
<button class="btn-text" onclick="switchAdminTab('logs')">æŸ¥çœ‹å…¨éƒ¨</button>
</div>
<div class="activity-list" id="recentActivity">
<div class="loading-text">åŠ è½½ä¸­...</div>
</div>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">å¿«æ·æ“ä½œ</h3>
</div>
<div class="quick-actions">
<button class="quick-action-btn" onclick="switchAdminTab('announcements')">
<span class="qa-icon">ğŸ“¢</span>
<span class="qa-text">å‘å¸ƒå…¬å‘Š</span>
</button>
<button class="quick-action-btn" onclick="switchAdminTab('users')">
<span class="qa-icon">ğŸ‘¥</span>
<span class="qa-text">ç®¡ç†ç”¨æˆ·</span>
</button>
<button class="quick-action-btn" onclick="switchAdminTab('messages')">
<span class="qa-icon">ğŸ’¬</span>
<span class="qa-text">æŸ¥çœ‹æ¶ˆæ¯</span>
</button>
<button class="quick-action-btn" onclick="clearAllMessages()">
<span class="qa-icon">ğŸ—‘ï¸</span>
<span class="qa-text">æ¸…ç©ºæ¶ˆæ¯</span>
</button>
</div>
</div>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">ç”¨æˆ·å¢é•¿å›¾è¡¨</h3>
</div>
<div class="chart-container">
<canvas id="userGrowthChart"></canvas>
</div>
</div>
</div>

<!-- Users Tab -->
<div class="admin-tab" id="tab-users">
<div class="admin-header">
<h2 class="admin-title">ç”¨æˆ·ç®¡ç†</h2>
<p class="admin-subtitle">ç®¡ç†æ‰€æœ‰æ³¨å†Œç”¨æˆ·</p>
</div>

<div class="admin-controls">
<input type="text" id="searchUser" class="form-input" placeholder="ğŸ” æœç´¢ç”¨æˆ·é‚®ç®±æˆ–ç”¨æˆ·å...">
<select id="userFilter" class="form-input">
<option value="all">å…¨éƒ¨ç”¨æˆ·</option>
<option value="admin">ç®¡ç†å‘˜</option>
<option value="online">åœ¨çº¿</option>
<option value="banned">å·²å°ç¦</option>
<option value="muted">å·²ç¦è¨€</option>
</select>
</div>

<div class="users-table" id="usersTable">
<div class="loading-text">åŠ è½½ç”¨æˆ·ä¸­...</div>
</div>
</div>

<!-- Messages Tab -->
<div class="admin-tab" id="tab-messages">
<div class="admin-header">
<h2 class="admin-title">æ¶ˆæ¯ç®¡ç†</h2>
<p class="admin-subtitle">ç›‘æ§å’Œç®¡ç†æ‰€æœ‰æ¶ˆæ¯</p>
</div>

<div class="admin-controls">
<input type="text" id="searchMessage" class="form-input" placeholder="ğŸ” æœç´¢æ¶ˆæ¯...">
<button class="btn btn-danger" onclick="clearAllMessages()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯</button>
</div>

<div class="messages-admin-list" id="messagesAdminList">
<div class="loading-text">åŠ è½½æ¶ˆæ¯ä¸­...</div>
</div>
</div>

<!-- Announcements Tab -->
<div class="admin-tab" id="tab-announcements">
<div class="admin-header">
<h2 class="admin-title">å…¬å‘Šç®¡ç†</h2>
<p class="admin-subtitle">åˆ›å»ºå’Œç®¡ç†å…¬å‘Š</p>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">åˆ›å»ºæ–°å…¬å‘Š</h3>
</div>
<div class="form-group">
<label class="form-label">æ ‡é¢˜</label>
<input type="text" id="announcementTitle" class="form-input" placeholder="å…¬å‘Šæ ‡é¢˜..." maxlength="100">
</div>
<div class="form-group">
<label class="form-label">å†…å®¹</label>
<textarea id="announcementText" class="form-textarea" placeholder="ç¼–å†™å…¬å‘Šå†…å®¹..." maxlength="1000" rows="5"></textarea>
</div>
<div class="form-group">
<label class="form-label">é™„ä»¶ï¼ˆå¯é€‰ï¼‰</label>
<input type="file" id="announcementFiles" multiple style="display: none;">
<input type="file" id="announcementFolder" webkitdirectory directory multiple style="display: none;">
<div style="display: flex; gap: 8px;">
<button class="btn btn-secondary" id="uploadAnnouncementFilesBtn">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
<button class="btn btn-secondary" id="uploadAnnouncementFolderBtn">ğŸ“ ä¸Šä¼ æ–‡ä»¶å¤¹</button>
</div>
<div id="announcementFilesPreview" class="file-preview-list"></div>
</div>
<div class="form-group">
<label class="form-label">å¾½ç« ç±»å‹</label>
<select id="announcementBadge" class="form-input">
<option value="Important">ğŸ”´ é‡è¦</option>
<option value="Info">â„¹ï¸ ä¿¡æ¯</option>
<option value="Update">ğŸ”„ æ›´æ–°</option>
<option value="Event">ğŸ‰ æ´»åŠ¨</option>
<option value="Warning">âš ï¸ è­¦å‘Š</option>
</select>
</div>
<button class="btn btn-primary" id="postAnnouncementBtn">ğŸ“¢ å‘å¸ƒå…¬å‘Š</button>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">å½“å‰å…¬å‘Š</h3>
</div>
<div id="announcementsManager">
<div class="loading-text">åŠ è½½å…¬å‘Šä¸­...</div>
</div>
</div>
</div>

<!-- Activity Logs Tab -->
<div class="admin-tab" id="tab-logs">
<div class="admin-header">
<h2 class="admin-title">æ“ä½œæ—¥å¿—</h2>
<p class="admin-subtitle">è¿½è¸ªæ‰€æœ‰ç®¡ç†å‘˜æ“ä½œå’Œç³»ç»Ÿäº‹ä»¶</p>
</div>

<div class="admin-controls">
<select id="logFilter" class="form-input">
<option value="all">å…¨éƒ¨æ“ä½œ</option>
<option value="BAN">å°ç¦</option>
<option value="UNBAN">è§£å°</option>
<option value="MUTE">ç¦è¨€</option>
<option value="UNMUTE">è§£é™¤ç¦è¨€</option>
<option value="DELETE">åˆ é™¤</option>
</select>
<button class="btn btn-secondary" onclick="exportLogs()">ğŸ“¥ å¯¼å‡ºæ—¥å¿—</button>
</div>

<div class="logs-list" id="logsList">
<div class="loading-text">åŠ è½½æ—¥å¿—ä¸­...</div>
</div>
</div>

<!-- Settings Tab -->
<div class="admin-tab" id="tab-settings">
<div class="admin-header">
<h2 class="admin-title">ç³»ç»Ÿè®¾ç½®</h2>
<p class="admin-subtitle">é…ç½®è®ºå›è®¾ç½®</p>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">å¸¸è§„è®¾ç½®</h3>
</div>
<div class="settings-list">
<div class="setting-item">
<div class="setting-info">
<div class="setting-name">è®ºå›åç§°</div>
<div class="setting-desc">æ›´æ”¹è®ºå›çš„åç§°</div>
</div>
<input type="text" class="form-input" id="forumName" value="ç¤¾åŒºè®ºå›">
</div>
<div class="setting-item">
<div class="setting-info">
<div class="setting-name">ç”¨æˆ·æ³¨å†Œ</div>
<div class="setting-desc">å…è®¸æ–°ç”¨æˆ·æ³¨å†Œ</div>
</div>
<label class="toggle-switch">
<input type="checkbox" id="allowRegistration" checked>
<span class="toggle-slider"></span>
</label>
</div>
<div class="setting-item">
<div class="setting-info">
<div class="setting-name">æ•æ„Ÿè¯è¿‡æ»¤</div>
<div class="setting-desc">è‡ªåŠ¨è¿‡æ»¤ä¸å½“å†…å®¹</div>
</div>
<label class="toggle-switch">
<input type="checkbox" id="profanityFilter" checked>
<span class="toggle-slider"></span>
</label>
</div>
<div class="setting-item">
<div class="setting-info">
<div class="setting-name">é€Ÿç‡é™åˆ¶</div>
<div class="setting-desc">é™åˆ¶æ¶ˆæ¯é¢‘ç‡ä»¥é˜²æ­¢åˆ·å±</div>
</div>
<label class="toggle-switch">
<input type="checkbox" id="rateLimiting" checked>
<span class="toggle-slider"></span>
</label>
</div>
<div class="setting-item">
<div class="setting-info">
<div class="setting-name">åº”ç”¨ç‰ˆæœ¬å·</div>
<div class="setting-desc">æ›´æ”¹ç‰ˆæœ¬å·ä¼šå¼ºåˆ¶æ‰€æœ‰ç”¨æˆ·æ›´æ–°</div>
</div>
<div style="display: flex; gap: 10px; align-items: center;">
<input type="text" class="form-input" id="appVersionInput" placeholder="5.1" style="max-width: 120px;">
<button class="btn btn-primary" id="updateVersionBtn">æ›´æ–°ç‰ˆæœ¬</button>
<span id="currentVersionDisplay" style="font-size: 12px; color: #666;">å½“å‰: v5.1</span>
</div>
</div>
</div>
<button class="btn btn-primary">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">æ•°æ®ç»´æŠ¤</h3>
</div>
<div class="danger-zone">
<button class="btn btn-primary" onclick="recalculateUserStats()">ğŸ”„ é‡æ–°è®¡ç®—ç”¨æˆ·ç»Ÿè®¡æ•°æ®</button>
<p style="font-size: 12px; color: #666; margin-top: 8px;">è®¡ç®—æ‰€æœ‰ç”¨æˆ·çš„å†å²æ¶ˆæ¯æ•°å’Œç‚¹èµæ•°</p>

<button class="btn btn-primary" onclick="migratePrivateMessages()" style="margin-top: 12px;">ğŸ“¨ è¿ç§»ç§ä¿¡æ•°æ®</button>
<p style="font-size: 12px; color: #666; margin-top: 8px;">å°†ç°æœ‰ç§ä¿¡è¿ç§»åˆ°æ–°çš„å¯¹è¯åˆ—è¡¨ç»“æ„ï¼ˆåªéœ€è¿è¡Œä¸€æ¬¡ï¼‰</p>
</div>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">å±é™©åŒºåŸŸ</h3>
</div>
<div class="danger-zone">
<button class="btn btn-danger" onclick="clearAllMessages()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯</button>
<button class="btn btn-danger" onclick="resetDatabase()">âš ï¸ é‡ç½®æ•°æ®åº“</button>
<button class="btn btn-danger" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
</div>
</div>
</div>

<!-- Analytics Tab -->
<div class="admin-tab" id="tab-analytics">
<div class="admin-header">
<h2 class="admin-title">æ•°æ®åˆ†æ</h2>
<p class="admin-subtitle">æ·±å…¥äº†è§£ç¤¾åŒºæ•°æ®å’Œè¶‹åŠ¿</p>
</div>

<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">æ—¥æ´»è·ƒç”¨æˆ·</div>
<div class="stat-value" id="dailyActiveUsers">0</div>
<div class="stat-change positive">è¾ƒæ˜¨æ—¥ +5%</div>
</div>
<div class="stat-card">
<div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
<div class="stat-value" id="avgResponseTime">2.3åˆ†é’Ÿ</div>
<div class="stat-change positive">è¾ƒæ˜¨æ—¥ -12%</div>
</div>
<div class="stat-card">
<div class="stat-label">æ¶ˆæ¯äº’åŠ¨ç‡</div>
<div class="stat-value" id="engagementRate">68%</div>
<div class="stat-change positive">è¾ƒæ˜¨æ—¥ +3%</div>
</div>
<div class="stat-card">
<div class="stat-label">æ–°å¢ç”¨æˆ·</div>
<div class="stat-value" id="newUsersToday">12</div>
<div class="stat-change positive">è¾ƒæ˜¨æ—¥ +20%</div>
</div>
</div>

<div class="admin-grid">
<div class="admin-card">
<div class="card-header">
<h3 class="card-title">ç”¨æˆ·æ´»è·ƒåº¦è¶‹åŠ¿</h3>
</div>
<div class="chart-container">
<canvas id="activityChart"></canvas>
</div>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ</h3>
</div>
<div class="chart-container">
<canvas id="messageTypeChart"></canvas>
</div>
</div>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">çƒ­é—¨è¯é¢˜</h3>
</div>
<div class="trending-topics" id="trendingTopics">
<div class="loading-text">åŠ è½½ä¸­...</div>
</div>
</div>
</div>

<!-- Permissions Tab -->
<div class="admin-tab" id="tab-permissions">
<div class="admin-header">
<h2 class="admin-title">æƒé™ç®¡ç†</h2>
<p class="admin-subtitle">ç®¡ç†ç”¨æˆ·è§’è‰²å’Œæƒé™</p>
</div>

<!-- Security Warning -->
<div class="admin-card" style="border-left: 4px solid #ff4444; background: #fff5f5;">
<div class="card-header">
<h3 class="card-title" style="color: #ff4444;">ğŸ”’ å®‰å…¨æç¤º</h3>
</div>
<div style="padding: 0 20px 20px;">
<p style="color: #666; margin-bottom: 10px;">è¯·ç¡®ä¿å·²å®Œæˆä»¥ä¸‹å®‰å…¨é…ç½®ï¼š</p>
<ul style="color: #666; margin-left: 20px; line-height: 1.8;">
<li>âœ… å·²é…ç½®Firebaseå®‰å…¨è§„åˆ™ï¼ˆè§ <code>firebase-security-rules.json</code>ï¼‰</li>
<li>âœ… ç®¡ç†å‘˜ä½¿ç”¨å¼ºå¯†ç ï¼ˆè‡³å°‘12ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰</li>
<li>âœ… å®šæœŸæ£€æŸ¥ç®¡ç†å‘˜åˆ—è¡¨ï¼Œç§»é™¤ä¸éœ€è¦çš„ç®¡ç†å‘˜</li>
<li>âœ… æŸ¥çœ‹å®Œæ•´å®‰å…¨æŒ‡å—ï¼š<code>SECURITY_GUIDE.md</code></li>
</ul>
</div>
</div>

<!-- Admin Management -->
<div class="admin-card">
<div class="card-header">
<h3 class="card-title">ğŸ‘‘ ç®¡ç†å‘˜åˆ—è¡¨</h3>
<button class="btn btn-primary" onclick="promoteToAdmin()">â• æ·»åŠ ç®¡ç†å‘˜</button>
</div>
<div class="admin-list" id="adminsList">
<div class="loading-text">åŠ è½½ä¸­...</div>
</div>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">è§’è‰²ç»Ÿè®¡</h3>
</div>
<div class="roles-stats" id="rolesStats">
<div class="role-stat-item">
<div class="role-stat-label">ç®¡ç†å‘˜</div>
<div class="role-stat-value" id="adminCount">0</div>
</div>
<div class="role-stat-item">
<div class="role-stat-label">æ™®é€šç”¨æˆ·</div>
<div class="role-stat-value" id="userCount">0</div>
</div>
<div class="role-stat-item">
<div class="role-stat-label">è¢«å°ç¦</div>
<div class="role-stat-value" id="bannedCount">0</div>
</div>
<div class="role-stat-item">
<div class="role-stat-label">è¢«ç¦è¨€</div>
<div class="role-stat-value" id="mutedCount">0</div>
</div>
</div>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">å¿«é€Ÿæ“ä½œ</h3>
</div>
<div class="quick-actions">
<input type="text" id="quickSearchUser" class="form-input" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±æœç´¢..." style="margin-bottom: 15px;">
<div id="quickSearchResults"></div>
</div>
</div>
</div>

<!-- Backup Tab -->
<div class="admin-tab" id="tab-backup">
<div class="admin-header">
<h2 class="admin-title">å¤‡ä»½ä¸æ¢å¤</h2>
<p class="admin-subtitle">ä¿æŠ¤æ‚¨çš„æ•°æ®å®‰å…¨</p>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">åˆ›å»ºå¤‡ä»½</h3>
</div>
<div class="backup-options">
<div class="backup-option">
<label class="checkbox-label">
<input type="checkbox" id="backupUsers" checked>
<span>ç”¨æˆ·æ•°æ®</span>
</label>
</div>
<div class="backup-option">
<label class="checkbox-label">
<input type="checkbox" id="backupMessages" checked>
<span>æ¶ˆæ¯æ•°æ®</span>
</label>
</div>
<div class="backup-option">
<label class="checkbox-label">
<input type="checkbox" id="backupAnnouncements" checked>
<span>å…¬å‘Šæ•°æ®</span>
</label>
</div>
<div class="backup-option">
<label class="checkbox-label">
<input type="checkbox" id="backupSettings" checked>
<span>ç³»ç»Ÿè®¾ç½®</span>
</label>
</div>
</div>
<button class="btn btn-primary" onclick="createBackup()">ğŸ“¦ åˆ›å»ºå¤‡ä»½</button>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">å¤‡ä»½å†å²</h3>
</div>
<div class="backup-list" id="backupList">
<div class="backup-item">
<div class="backup-info">
<div class="backup-name">å®Œæ•´å¤‡ä»½ - 2024-01-15</div>
<div class="backup-meta">å¤§å°: 2.5 MB â€¢ åŒ…å«: æ‰€æœ‰æ•°æ®</div>
</div>
<div class="backup-actions">
<button class="btn-icon" onclick="downloadBackup('backup-1')">ä¸‹è½½</button>
<button class="btn-icon" onclick="restoreBackup('backup-1')">æ¢å¤</button>
<button class="btn-icon danger" onclick="deleteBackup('backup-1')">åˆ é™¤</button>
</div>
</div>
</div>
</div>

<div class="admin-card">
<div class="card-header">
<h3 class="card-title">æ¢å¤æ•°æ®</h3>
</div>
<div class="restore-section">
<input type="file" id="restoreFile" accept=".json" style="display: none;">
<button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">ğŸ“ é€‰æ‹©å¤‡ä»½æ–‡ä»¶</button>
<p style="color: #666; font-size: 13px; margin-top: 10px;">âš ï¸ æ¢å¤æ“ä½œå°†è¦†ç›–å½“å‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ</p>
</div>
</div>
</div>

</div>
</div>
</div>
</div>
</div>


</div>

<!-- Announcement Detail Modal -->
<div class="modal" id="announcementDetailModal">
<div class="modal-content announcement-detail-modal">
<div class="modal-header">
<h3 class="modal-title" id="announcementDetailTitle">Announcement</h3>
<button class="modal-close" id="closeAnnouncementDetailModal">âœ•</button>
</div>
<div class="modal-body">
<div class="announcement-detail-meta" id="announcementDetailMeta"></div>
<div class="announcement-detail-image" id="announcementDetailImage"></div>
<div class="announcement-detail-content" id="announcementDetailContent"></div>
</div>
</div>
</div>

<!-- Avatar Upload Modal -->
<div class="modal" id="avatarModal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">Change Avatar</h3>
<button class="modal-close" id="closeAvatarModal">âœ•</button>
</div>
<div class="modal-body">
<div class="avatar-preview-container">
<div class="avatar-preview" id="avatarPreview"></div>
</div>
<div class="avatar-options">
<div class="avatar-option-section">
<h4 class="avatar-option-title">Upload Custom Image</h4>
<input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
<button class="btn btn-secondary" id="uploadAvatarBtn">ğŸ“ Choose Image</button>
<p class="avatar-hint">Recommended: Square image, max 2MB</p>
</div>
<div class="avatar-option-section">
<h4 class="avatar-option-title">Or Choose a Color</h4>
<div class="color-picker" id="colorPicker">
<div class="color-option" data-color="#FF6B6B" style="background: #FF6B6B;"></div>
<div class="color-option" data-color="#4ECDC4" style="background: #4ECDC4;"></div>
<div class="color-option" data-color="#45B7D1" style="background: #45B7D1;"></div>
<div class="color-option" data-color="#FFA07A" style="background: #FFA07A;"></div>
<div class="color-option" data-color="#98D8C8" style="background: #98D8C8;"></div>
<div class="color-option" data-color="#F7DC6F" style="background: #F7DC6F;"></div>
<div class="color-option" data-color="#BB8FCE" style="background: #BB8FCE;"></div>
<div class="color-option" data-color="#85C1E2" style="background: #85C1E2;"></div>
<div class="color-option" data-color="#F8B739" style="background: #F8B739;"></div>
<div class="color-option" data-color="#52B788" style="background: #52B788;"></div>
</div>
</div>
</div>
<button class="btn btn-primary" id="saveAvatarBtn">Save Avatar</button>
</div>
</div>
</div>

<!-- User Profile Modal -->
<div class="modal" id="userProfileModal">
<div class="modal-content user-profile-modal">
<div class="modal-header">
<h3>ç”¨æˆ·èµ„æ–™</h3>
<button class="modal-close" onclick="closeUserProfile()">âœ•</button>
</div>
<div class="user-profile-content">
<div class="profile-header">
<div class="profile-avatar" id="profileAvatar"></div>
<div class="profile-info">
<h2 class="profile-username" id="profileUsername"></h2>
<p class="profile-status" id="profileStatus"></p>
</div>
</div>
<div class="profile-stats">
<div class="stat-item">
<div class="stat-number" id="profileMessageCount">0</div>
<div class="stat-label">æ¶ˆæ¯æ•°</div>
</div>
<div class="stat-item">
<div class="stat-number" id="profileLikesReceived">0</div>
<div class="stat-label">è·èµæ•°</div>
</div>
<div class="stat-item">
<div class="stat-number" id="profileJoinDate">-</div>
<div class="stat-label">åŠ å…¥æ—¶é—´</div>
</div>
</div>
<div class="profile-badges" id="profileBadges" style="display: none;"></div>
<div class="profile-level" id="profileLevel" style="display: none;"></div>
<div class="profile-actions" id="profileActions"></div>
</div>
</div>
</div>

<!-- Typing Indicator -->
<div class="typing-indicator" id="typingIndicator" style="display: none;">
<span class="typing-user"></span> æ­£åœ¨è¾“å…¥<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
</div>

<!-- End App -->
<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBKnlUua7B6gzttWKXAhwHRLGql0yGweXY",
  authDomain: "puff-forum.firebaseapp.com",
  databaseURL: "https://puff-forum-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "puff-forum",
  storageBucket: "puff-forum.firebasestorage.app",
  messagingSenderId: "875683260753",
  appId: "1:875683260753:web:494cc5973e166c74858b70"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

// Initialize app version in Firebase
async function initializeAppVersion() {
  try {
    const versionRef = database.ref('appVersion');
    const snapshot = await versionRef.once('value');

    if (!snapshot.exists()) {
      // Set initial version
      await versionRef.set({
        current: CURRENT_VERSION,
        updatedAt: Date.now(),
        updatedBy: 'system'
      });
      console.log('ğŸ“¦ App version initialized:', CURRENT_VERSION);
    }
  } catch (error) {
    console.error('âŒ Failed to initialize app version:', error);
  }
}

// Initialize app version on page load
initializeAppVersion();
</script>

<!-- PWA Service Worker Registration -->
<script>
// å½“å‰ç‰ˆæœ¬å· (ä»…ç”¨äºåˆå§‹åŒ– Firebase)
const CURRENT_VERSION = '5.1';

// åˆå§‹åŒ– localStorage ç‰ˆæœ¬å·(å¦‚æœä¸å­˜åœ¨)
if (!localStorage.getItem('app_version')) {
  console.log('ğŸ“¦ Initializing app version in localStorage:', CURRENT_VERSION);
  localStorage.setItem('app_version', CURRENT_VERSION);
}

// æ³¨å†Œ Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('âœ… Service Worker registered:', registration.scope);

        // æ¯éš” 60 ç§’æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
        setInterval(() => {
          registration.update();
        }, 60000);

        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New service worker available
              console.log('ğŸ†• New Service Worker available!');
              // Don't use confirm, let the Firebase listener handle it
              newWorker.postMessage({ action: 'skipWaiting' });
            }
          });
        });
      })
      .catch((error) => {
        console.log('âŒ Service Worker registration failed:', error);
      });
  });
}

// Install prompt removed - Install App button disabled
</script>

<!-- Load main app with cache-busting version parameter -->
<script src="app.js?v=5.2"></script>
</body>
</html>
